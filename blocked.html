<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Blocked - ATAV Safe Browsing</title>
    <link rel="stylesheet" href="blocked.css">
</head>
<body>
    <div class="container" id="blockContainer">
        <h1><span class="danger-icon"></span> Site Blocked: Potentially Dangerous</h1>
        <p>The website you attempted to access has been flagged as potentially dangerous by <strong>ATAV Safe Browsing</strong>.</p>
        
        <div class="details">
            <p><strong>Blocked Host:</strong> <span id="host">N/A</span></p>
            <p><strong>Assessed Risk:</strong> <span id="risk">N/A</span></p>
            <p><strong>Category:</strong> <span id="category">N/A</span></p>
            <p><strong>Original URL:</strong> <span id="originalUrlDisplay">N/A</span></p>
        </div>
        
        <p>We strongly advise against proceeding to this site. Your security is important.</p>
        
        <div class="actions">
            <button id="goBackButton" title="Go to the previous page or a new tab">Go Back Safely</button>
            <button id="continueButton" title="Proceed to the blocked site (not recommended)">Continue Anyway</button>
            <button id="stopCloseButton" title="Stop loading and close this page immediately">Stop & Close</button>
        </div>
        <p class="footer-note">If you believe this is a mistake, you can report it using the ATAV Safe Browsing extension icon in your browser toolbar.</p>
    </div>

    <div id="frameContainer" style="display:none; width:100%; height:95vh; flex-direction:column;">
        <div style="display:flex; justify-content:flex-end; background: #f8f8f8; padding: 8px;">
            <button id="closeFrameButton" style="background:red;color:#fff; border:none; padding: 8px 12px; cursor:pointer;">Stop & Close</button>
            <button id="backToBlockPage" style="margin-left:10px; background:#333;color:#fff;border:none;padding:8px 12px;cursor:pointer;">Return to Warning</button>
        </div>
        <iframe id="blockedIframe" src="about:blank" style="width:100%; height:90vh; border:none;"></iframe>
    </div>

    <script>
        /**
         * YOU MUST ENSURE THAT THE "originalUrlDisplay" SPAN IS POPULATED WITH THE CORRECT URL
         * BEFORE THE USER PRESSES "Continue Anyway".
         * 
         * This code expects the original URL to be injected into the span#originalUrlDisplay
         * by your extension's script, or by setting sessionStorage['blockedUrl'] before loading this page.
         * 
         * If nothing is set, the iframe will NOT attempt to load an invalid URL.
         */

        function getOriginalUrl() {
            // Try to get from span first (injected by extension)
            var url = document.getElementById('originalUrlDisplay').textContent?.trim();
            if (url && url !== "N/A" && url !== "") return url;
            // Fallback: try to get from sessionStorage
            if (window.sessionStorage) {
                var ss = sessionStorage.getItem('blockedUrl');
                if (ss && ss !== '') return ss;
            }
            return '';
        }

        document.getElementById('continueButton').addEventListener('click', function() {
            var originalUrl = getOriginalUrl();
            if (!/^https?:\/\//i.test(originalUrl)) {
                alert('Invalid or missing original URL. (Value: "' + originalUrl + '")');
                return;
            }
            document.getElementById('blockContainer').style.display = 'none';
            document.getElementById('frameContainer').style.display = 'flex';
            var frame = document.getElementById('blockedIframe');
            frame.src = originalUrl;
        });

        function stopAndClose() {
            try { if (typeof window.stop === 'function') window.stop(); } catch(e){}
            window.close();
        }
        document.getElementById('stopCloseButton').addEventListener('click', stopAndClose);
        document.getElementById('closeFrameButton').addEventListener('click', stopAndClose);

        document.getElementById('backToBlockPage').addEventListener('click', function() {
            document.getElementById('blockedIframe').src = 'about:blank';
            document.getElementById('frameContainer').style.display = 'none';
            document.getElementById('blockContainer').style.display = 'block';
        });

        // Optionally auto-fill "originalUrlDisplay" on page load if possible
        window.addEventListener('DOMContentLoaded', function() {
            var url = getOriginalUrl();
            if (url) document.getElementById('originalUrlDisplay').textContent = url;
        });
    </script>
    <script src="blocked.js"></script>
</body>
</html>
